services:
  api:
    image: ghcr.io/saleor/saleor:latest
    ports:
      - 8000:8000
    restart: unless-stopped
    networks:
      # - saleor-backend-tier
      - dokploy-network
    stdin_open: true
    tty: true
    depends_on:
      # - db
      # - redis
      - jaeger
    volumes:
      # shared volume between worker and api for media
      - saleor-media:/app/media
    env_file:
      - common.env
      - backend.env
      - .env
    environment:
      - API_URL=https://api.shopinsta.io/graphql/
      - ALLOWED_GRAPHQL_ORIGINS=https://dashboard.shopinsta.io
      - CORS_ALLOWED_ORIGINS=https://dashboard.shopinsta.io
      - DASHBOARD_URL=https://dashboard.shopinsta.io
      - SECURE_PROXY_SSL_HEADER=HTTP_X_FORWARDED_PROTO,https
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.saleor-api-manual.rule=Host(`api.shopinsta.io`)"
      - "traefik.http.routers.saleor-api-manual.entrypoints=websecure"
      - "traefik.http.routers.saleor-api-manual.tls.certResolver=letsencrypt"
      - "traefik.http.routers.saleor-api-manual.middlewares=saleor-https-header"
      - "traefik.http.middlewares.saleor-https-header.headers.customresponseheaders.X-Forwarded-Proto=https"
      - "traefik.http.services.saleor-api-manual.loadbalancer.server.port=8000"
    
  dashboard:
    image: ghcr.io/saleor/saleor-dashboard:latest
    ports:
      - 9000:80
    restart: unless-stopped
    env_file:
      - common.env
      - backend.env
      - .env
    environment:
      - API_URL=https://api.shopinsta.io/graphql/
    networks:
      - dokploy-network   
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.saleor-dash-manual.rule=Host(`dashboard.shopinsta.io`)"
      - "traefik.http.routers.saleor-dash-manual.entrypoints=websecure"
      - "traefik.http.routers.saleor-dash-manual.tls.certResolver=letsencrypt"
      - "traefik.http.routers.saleor-dash-manual.middlewares=saleor-https-header"
      - "traefik.http.services.saleor-dash-manual.loadbalancer.server.port=80"
  # db:
  #   image: library/postgres:15-alpine
  #   ports:
  #     - 5432:5432
  #   restart: unless-stopped
  #   networks:
  #     # - saleor-backend-tier
  #     - dokploy-network
  #   volumes:
  #     - saleor-db:/var/lib/postgresql/data
  #     - ./replica_user.sql:/docker-entrypoint-initdb.d/replica_user.sql:ro,z
  #   environment:
  #     - POSTGRES_USER=saleor
  #     - POSTGRES_PASSWORD=saleor

  # redis:
  #   image: library/redis:7.0-alpine
  #   ports:
  #     - 6379:6379
  #   restart: unless-stopped
  #   networks:
  #     # - saleor-backend-tier
  #     - dokploy-network
  #   volumes:
  #     - saleor-redis:/data

  worker:
    image: ghcr.io/saleor/saleor:latest
    command: celery -A saleor --app=saleor.celeryconf:app worker --loglevel=info -B
    restart: unless-stopped
    networks:
      # - saleor-backend-tier
      - dokploy-network
    env_file:
      - common.env
      - backend.env
      - .env
    depends_on:
      # - redis
      - mailpit
    volumes:
      # shared volume between worker and api for media
      - saleor-media:/app/media

  jaeger:
    image: jaegertracing/jaeger
    ports:
      - "16686:16686"
      - "4317:4317"
      - "4318:4318"
    restart: unless-stopped
    networks:
      # - saleor-backend-tier
      - dokploy-network
    volumes:
      - type: tmpfs
        target: /tmp

  mailpit:
    image: axllent/mailpit
    ports:
      - 1025:1025 # smtp server
      - 8025:8025 # web ui. Visit http://localhost:8025/ to check emails
    restart: unless-stopped
    networks:
      # - saleor-backend-tier
      - dokploy-network

volumes:
  saleor-db:
    driver: local
  saleor-redis:
    driver: local
  saleor-media:

networks:
  # saleor-backend-tier:
    # driver: bridge
  dokploy-network:
    external: true # Indicates that this network is managed externally by Dokploy
